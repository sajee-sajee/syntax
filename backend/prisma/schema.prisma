generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String      @id @default(uuid())
  email            String      @unique
  provider         String      // 'local', 'google', 'github'
  passwordHash     String?     // null if oauth
  characterCreated Boolean     @default(false)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  character        Character?
  attempts         Attempt[]
  ranking          Ranking?
  streak           Streak?
  roomParticipants RoomParticipant[]
}

model Character {
  id             String   @id @default(uuid())
  userId         String   @unique
  displayName    String   @unique
  hair           String   @default("default_hair")
  glasses        String?
  dress          String   @default("default_dress")
  shoes          String   @default("default_shoes")
  aura           String   @default("default_aura")
  xp             Int      @default(0)
  evolutionStage Int      @default(1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Region {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  order       Int
  description String
  lore        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  levels      Level[]
}

model Level {
  id          String   @id @default(uuid())
  regionId    String
  order       Int
  title       String
  storyIntro  String
  learningMd  String
  isBoss      Boolean  @default(false)
  
  region      Region   @relation(fields: [regionId], references: [id], onDelete: Cascade)
  problem     Problem?
}

model Problem {
  id            String   @id @default(uuid())
  levelId       String?  @unique
  title         String
  description   String
  difficulty    String   // 'easy', 'medium', 'hard'
  topicTags     String[]
  starterCode   Json     // Store as Record<string, string> mappings (language -> code)
  timeLimitMs   Int      @default(2000)
  memoryLimitMb Int      @default(256)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  level         Level?   @relation(fields: [levelId], references: [id], onDelete: SetNull)
  testCases     TestCase[]
  attempts      Attempt[]
  dailyQuests   DailyQuest[]
}

model TestCase {
  id             String   @id @default(uuid())
  problemId      String
  input          String
  expectedOutput String
  isHidden       Boolean  @default(false)

  problem        Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
}

model Attempt {
  id            String   @id @default(uuid())
  userId        String
  problemId     String
  language      String
  code          String
  status        String   // 'accepted', 'wrong_answer', 'tle', 'mle', 'error', 'pending'
  testsPassed   Int
  testsTotal    Int
  execTimeMs    Int?
  memoryMb      Int?
  attemptNumber Int
  submittedAt   DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  problem       Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
}

model Ranking {
  userId           String   @id
  skillScore       Int      @default(0)
  consistencyScore Int      @default(0)
  codeQualityScore Int      @default(0)
  totalScore       Int      @default(0)
  tier             String   @default("Recruit")
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Streak {
  userId         String   @id
  currentStreak  Int      @default(0)
  longestStreak  Int      @default(0)
  lastActiveDate DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Room {
  id            String   @id @default(uuid())
  hostUserId    String
  code          String   @unique
  difficulty    String
  topic         String
  timeLimitSec  Int
  questionCount Int
  status        String   @default("waiting") // 'waiting', 'in_progress', 'finished'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  participants  RoomParticipant[]
}

model RoomParticipant {
  roomId        String
  userId        String
  characterName String
  score         Int      @default(0)
  rank          Int      @default(0)
  joinedAt      DateTime @default(now())

  room          Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([roomId, userId])
}

model DailyQuest {
  id          String   @id @default(uuid())
  date        DateTime @unique
  questType   String   // 'debug', 'predict', 'optimize', 'edge_case'
  problemId   String

  problem     Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)
}
